name: Windows Server 2019 CI

on: [push, workflow_dispatch]

jobs:
  build-1:
    runs-on: windows-2019
    env:
      VCPKG_TRIPLET: x64-windows
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
        path: source
    - name: Inspect environment
      run: |
        vswhere -latest
      shell: pwsh
    - name: Install dependencies [1/2]
      run: |
        vcpkg install dirent eigen3 fontconfig freetype harfbuzz libepoxy libogg libpng opus opusfile --triplet=$Env:VCPKG_TRIPLET
      shell: pwsh
    - name: Clear build files
      run: |
        $buildtree = Join-Path $Env:VCPKG_ROOT buildtrees
        $download = Join-Path $Env:VCPKG_ROOT downloads
        Remove-Item -Path $buildtree -Recurse
        Remove-Item -Path $download -Recurse
      shell: pwsh
    - name: Install dependencies [2/2]
      run: |
        vcpkg install qt5-base qt5-declarative qt5-quickcontrols --triplet=$Env:VCPKG_TRIPLET
      shell: pwsh
    - name: Clear build files
      run: |
        $buildtree = Join-Path $Env:VCPKG_ROOT buildtrees
        $download = Join-Path $Env:VCPKG_ROOT downloads
        Remove-Item -Path $buildtree -Recurse
        Remove-Item -Path $download -Recurse
      shell: pwsh
    - name: Export dependencies
      run: |
        vcpkg export dirent eigen3 fontconfig freetype harfbuzz libepoxy libogg libpng opus opusfile qt5-base qt5-declarative qt5-quickcontrols --triplet=x64-windows --7zip --output-dir="." --output="package-1.7z"
        dir
      shell: pwsh
    - name: Publish exported dependencies
      uses: actions/upload-artifact@v2.2.4
      with:
        name: openage-dependency
        path: './package-1.7z'
        if-no-files-found: error
        retention-days: 30
  build-2:
    runs-on: windows-2019
    env:
      VCPKG_TRIPLET: x64-windows
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
        path: source
    - name: Inspect environment
      run: |
        vswhere -latest
      shell: pwsh
    - name: Install dependencies [2/2]
      run: |
        vcpkg install qt5-base qt5-declarative qt5-quickcontrols --triplet=$Env:VCPKG_TRIPLET
      shell: pwsh
    - name: Clear build files
      run: |
        $buildtree = Join-Path $Env:VCPKG_ROOT buildtrees
        $download = Join-Path $Env:VCPKG_ROOT downloads
        Remove-Item -Path $buildtree -Recurse
        Remove-Item -Path $download -Recurse
      shell: pwsh
    - name: Export dependencies
      run: |
        vcpkg export qt5-base qt5-declarative qt5-quickcontrols sdl2 sdl2-image --triplet=x64-windows --7zip --output-dir="." --output="package-2.7z"
        dir
      shell: pwsh
    - name: Publish exported dependencies
      uses: actions/upload-artifact@v2.2.4
      with:
        name: openage-dependency
        path: './package-2.7z'
        if-no-files-found: error
        retention-days: 30
